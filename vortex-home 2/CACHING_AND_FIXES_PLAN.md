# üéØ –ü–õ–ê–ù: –ö–≠–®–ò–†–û–í–ê–ù–ò–ï –ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –†–û–£–¢–ò–ù–ì–ê –î–ê–ù–ù–´–•

**–î–∞—Ç–∞:** 15 –Ω–æ—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** vortex-home 2  
**–ó–∞–¥–∞—á–∏:** –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è + –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ—É—Ç–∏–Ω–≥–∞ VK Statistics

---

## üìã OVERVIEW

### –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:

1. ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**
   - Server-side cache (–≤ –ø–∞–º—è—Ç–∏)
   - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
   - TTL –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
   - –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞

2. ‚úÖ **–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–æ—É—Ç–∏–Ω–≥ VK Statistics**
   - –î–æ–±–∞–≤–∏—Ç—å VK Stats –≤ Dashboard
   - –î–æ–±–∞–≤–∏—Ç—å VK Stats –≤ Marketing
   - –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—á–µ—Ç—ã

3. ‚ö†Ô∏è **–ó–∞–º–µ–Ω–∏—Ç—å mock –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ**
   - –¢—Ä–µ–Ω–¥ –≤—ã—Ä—É—á–∫–∏
   - –ê–Ω–∞–ª–∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π

---

## üóÑÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ö–≠–®–ò–†–û–í–ê–ù–ò–Ø

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:

1. **NO DUPLICATION** (–∫—Ä–∏—Ç–∏—á–Ω–æ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
   - –û–¥–Ω–∏ –∏ —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –¥–æ–ª–∂–Ω—ã –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è
   - –ö—ç—à –∫–ª—é—á–∏ –¥–æ–ª–∂–Ω—ã —É—á–∏—Ç—ã–≤–∞—Ç—å –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞

2. **TTL (Time To Live)**
   - –†–∞–∑–Ω–æ–µ –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π

3. **–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è**
   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
   - –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

4. **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**
   - –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏ (–±—ã—Å—Ç—Ä–æ)
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ overhead –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –∫—ç—à–∞

---

## üèóÔ∏è –°–¢–†–£–ö–¢–£–†–ê –ö–≠–®–ê

### –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –∏ TTL:

```typescript
const CACHE_TTL = {
  // Yandex –¥–∞–Ω–Ω—ã–µ
  YANDEX_ORDERS: 5 * 60 * 1000,      // 5 –º–∏–Ω—É—Ç (—á–∞—Å—Ç–æ –º–µ–Ω—è—é—Ç—Å—è)
  YANDEX_PRODUCTS: 30 * 60 * 1000,   // 30 –º–∏–Ω—É—Ç (—Ä–µ–¥–∫–æ –º–µ–Ω—è—é—Ç—Å—è)
  YANDEX_CAMPAIGNS: 60 * 60 * 1000,  // 1 —á–∞—Å (—Å—Ç–∞—Ç–∏—á–Ω—ã–µ)
  
  // VK –¥–∞–Ω–Ω—ã–µ
  VK_CAMPAIGNS: 15 * 60 * 1000,      // 15 –º–∏–Ω—É—Ç
  VK_AD_GROUPS: 15 * 60 * 1000,      // 15 –º–∏–Ω—É—Ç
  VK_BANNERS: 15 * 60 * 1000,        // 15 –º–∏–Ω—É—Ç
  VK_STATISTICS: 10 * 60 * 1000,     // 10 –º–∏–Ω—É—Ç (—á–∞—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è)
  
  // –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  DASHBOARD_SUMMARY: 5 * 60 * 1000,  // 5 –º–∏–Ω—É—Ç
  TOP_PRODUCTS: 10 * 60 * 1000,      // 10 –º–∏–Ω—É—Ç
};
```

### –ö–ª—é—á–∏ –∫—ç—à–∞ (–¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏):

```typescript
// Yandex Orders
`yandex:orders:${campaignId}:${dateFrom}:${dateTo}:page${page}`

// Yandex Products
`yandex:products:${campaignId}`

// VK Campaigns
`vk:campaigns:${adPlanId || 'all'}`

// VK Statistics
`vk:stats:adgroups:${dateFrom}:${dateTo}:ids${adGroupIds.sort().join(',')}`

// Dashboard Summary
`dashboard:summary:${period}:${dateFrom}:${dateTo}`

// Top Products
`top:products:${period}:${dateFrom}:${dateTo}`
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ:** –ö–ª—é—á–∏ –≤–∫–ª—é—á–∞—é—Ç –í–°–ï –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

---

## üíæ –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø: server/cache/cacheManager.ts

```typescript
interface CacheEntry<T> {
  data: T;
  timestamp: number;
  ttl: number;
}

class CacheManager {
  private cache: Map<string, CacheEntry<any>> = new Map();
  private cleanupInterval: NodeJS.Timeout;

  constructor() {
    // –û—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
    this.cleanupInterval = setInterval(() => {
      this.cleanup();
    }, 5 * 60 * 1000);
  }

  get<T>(key: string): T | null {
    const entry = this.cache.get(key);
    
    if (!entry) return null;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ TTL
    const now = Date.now();
    if (now - entry.timestamp > entry.ttl) {
      this.cache.delete(key);
      return null;
    }
    
    return entry.data as T;
  }

  set<T>(key: string, data: T, ttl: number): void {
    this.cache.set(key, {
      data,
      timestamp: Date.now(),
      ttl,
    });
  }

  delete(key: string): void {
    this.cache.delete(key);
  }

  deletePattern(pattern: string): number {
    let deleted = 0;
    for (const key of this.cache.keys()) {
      if (key.includes(pattern)) {
        this.cache.delete(key);
        deleted++;
      }
    }
    return deleted;
  }

  clear(): void {
    this.cache.clear();
  }

  private cleanup(): void {
    const now = Date.now();
    let cleaned = 0;
    
    for (const [key, entry] of this.cache.entries()) {
      if (now - entry.timestamp > entry.ttl) {
        this.cache.delete(key);
        cleaned++;
      }
    }
    
    if (cleaned > 0) {
      console.log(`üßπ Cache cleanup: —É–¥–∞–ª–µ–Ω–æ ${cleaned} —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π`);
    }
  }

  getStats() {
    return {
      totalEntries: this.cache.size,
      oldestEntry: this.getOldestEntry(),
      newestEntry: this.getNewestEntry(),
    };
  }

  private getOldestEntry(): number {
    let oldest = Date.now();
    for (const entry of this.cache.values()) {
      if (entry.timestamp < oldest) {
        oldest = entry.timestamp;
      }
    }
    return oldest;
  }

  private getNewestEntry(): number {
    let newest = 0;
    for (const entry of this.cache.values()) {
      if (entry.timestamp > newest) {
        newest = entry.timestamp;
      }
    }
    return newest;
  }
}

export const cacheManager = new CacheManager();

// TTL –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
export const CACHE_TTL = {
  YANDEX_ORDERS: 5 * 60 * 1000,
  YANDEX_PRODUCTS: 30 * 60 * 1000,
  YANDEX_CAMPAIGNS: 60 * 60 * 1000,
  VK_CAMPAIGNS: 15 * 60 * 1000,
  VK_AD_GROUPS: 15 * 60 * 1000,
  VK_BANNERS: 15 * 60 * 1000,
  VK_STATISTICS: 10 * 60 * 1000,
  DASHBOARD_SUMMARY: 5 * 60 * 1000,
  TOP_PRODUCTS: 10 * 60 * 1000,
};
```

---

## üîß –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –í BACKEND ROUTES

### –ü—Ä–∏–º–µ—Ä: server/routes/yandex.ts

```typescript
import { cacheManager, CACHE_TTL } from '../cache/cacheManager';

export const getOrders: RequestHandler = async (req, res) => {
  try {
    const { date_from, date_to } = req.query;
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –∫—ç—à–∞
    const cacheKey = `yandex:orders:all:${date_from}:${date_to}`;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
    const cachedData = cacheManager.get<any>(cacheKey);
    if (cachedData) {
      console.log(`‚úÖ Cache HIT: ${cacheKey}`);
      return res.json({
        success: true,
        data: cachedData,
        cached: true,
      });
    }
    
    console.log(`‚ùå Cache MISS: ${cacheKey}`);
    
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥)
    const allOrders: any[] = [];
    for (const campaignId of YANDEX_CAMPAIGN_IDS) {
      // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ ...
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
    cacheManager.set(cacheKey, allOrders, CACHE_TTL.YANDEX_ORDERS);
    console.log(`üíæ Cached: ${cacheKey} (${allOrders.length} orders)`);
    
    res.json({
      success: true,
      data: allOrders,
      cached: false,
    });
  } catch (error) {
    // ... error handling ...
  }
};
```

### –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:

1. **–ö–ª—é—á –≤–∫–ª—é—á–∞–µ—Ç –í–°–ï –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**
   - `date_from`, `date_to`
   - –î–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ!

2. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - Cache HIT/MISS –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
   - –†–∞–∑–º–µ—Ä –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

3. **–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ –æ—Ç–≤–µ—Ç–µ**
   - `cached: true/false`
   - –§—Ä–æ–Ω—Ç–µ–Ω–¥ –º–æ–∂–µ—Ç –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å "last updated"

---

## üîÑ –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –í VK ROUTES

### –ü—Ä–∏–º–µ—Ä: server/routes/vk.ts

```typescript
export const getStatistics: RequestHandler = async (req, res) => {
  try {
    const { date_from, date_to } = req.query;
    
    // –ö–ª—é—á –∫—ç—à–∞
    const cacheKey = `vk:stats:${date_from}:${date_to}`;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
    const cachedStats = cacheManager.get<any>(cacheKey);
    if (cachedStats) {
      console.log(`‚úÖ VK Stats Cache HIT`);
      return res.json({
        success: true,
        ...cachedStats,
        cached: true,
      });
    }
    
    console.log(`‚ùå VK Stats Cache MISS`);
    
    // –ü–æ–ª—É—á–∞–µ–º ad_groups (–º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–æ –æ—Ç–¥–µ–ª—å–Ω–æ)
    const adGroupsCacheKey = `vk:adgroups:all`;
    let adGroups = cacheManager.get<any[]>(adGroupsCacheKey);
    
    if (!adGroups) {
      const adGroupsData = await vkFetch<{ items: any[] }>("/ad_groups.json?limit=200");
      adGroups = adGroupsData.items || [];
      cacheManager.set(adGroupsCacheKey, adGroups, CACHE_TTL.VK_AD_GROUPS);
    }
    
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    const adGroupIds = adGroups.map(g => g.id).join(",");
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ ...
    
    const result = {
      data: statsData.items || [],
      total: { /* ... */ },
    };
    
    // –ö—ç—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    cacheManager.set(cacheKey, result, CACHE_TTL.VK_STATISTICS);
    
    res.json({
      success: true,
      ...result,
      cached: false,
    });
  } catch (error) {
    // ... error handling ...
  }
};
```

---

## üé® –û–ë–ù–û–í–õ–ï–ù–ò–ï FRONTEND: dataService.ts

### –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞:

```typescript
async getDashboardSummary(period: string): Promise<DashboardSummary> {
  const periodParams = getPeriodParams(period);

  try {
    const [orders, campaigns, vkStats] = await Promise.all([
      yandexAPI.getOrders(periodParams.from, periodParams.to),
      vkAPI.getCampaigns(),
      vkAPI.getStatistics(periodParams.from, periodParams.to), // ‚úÖ –ù–û–í–û–ï!
    ]);

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞
    const isCached = (orders as any).cached || (vkStats as any).cached;
    if (isCached) {
      console.log('üì¶ Using cached data for dashboard');
    }

    // Yandex –º–µ—Ç—Ä–∏–∫–∏ (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥)
    const totalRevenue = orders.reduce(/* ... */);
    const totalOrders = orders.length;

    // ‚úÖ VK –º–µ—Ç—Ä–∏–∫–∏ (–ù–û–í–û–ï!)
    const adSpend = vkStats.total?.spent || 0;
    const totalClicks = vkStats.total?.clicks || 0;
    const totalShows = vkStats.total?.shows || 0;

    // –†–∞—Å—á–µ—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ VK –¥–∞–Ω–Ω—ã–º–∏
    const aov = totalOrders > 0 ? totalRevenue / totalOrders : 0;
    const ctr = totalShows > 0 ? (totalClicks / totalShows) * 100 : 0;
    const cpc = totalClicks > 0 ? adSpend / totalClicks : 0;
    const conversionRate = totalClicks > 0 ? (totalOrders / totalClicks) * 100 : 0;
    const roas = adSpend > 0 ? totalRevenue / adSpend : 0;

    return {
      metrics: {
        total_revenue: totalRevenue,
        total_orders: totalOrders,
        ad_spend: adSpend,        // ‚úÖ –†–µ–∞–ª—å–Ω—ã–π
        roas: roas,               // ‚úÖ –†–µ–∞–ª—å–Ω—ã–π
        ctr: ctr,                 // ‚úÖ –†–µ–∞–ª—å–Ω—ã–π
        cpc: cpc,                 // ‚úÖ –†–µ–∞–ª—å–Ω—ã–π
        conversion_rate: conversionRate, // ‚úÖ –†–µ–∞–ª—å–Ω—ã–π
        total_clicks: totalClicks,       // ‚úÖ –†–µ–∞–ª—å–Ω—ã–π
        total_shows: totalShows,         // ‚úÖ –†–µ–∞–ª—å–Ω—ã–π
      }
    };
  } catch (error) {
    console.error("Error:", error);
    return mockDashboardSummary;
  }
}
```

---

## üìä –û–ë–ù–û–í–õ–ï–ù–ò–ï getCampaigns()

```typescript
async getCampaigns(period: string = "30d"): Promise<Campaign[]> {
  const periodParams = getPeriodParams(period);

  try {
    const [campaigns, stats] = await Promise.all([
      vkAPI.getCampaigns(),
      vkAPI.getStatistics(periodParams.from, periodParams.to), // ‚úÖ –ù–û–í–û–ï!
    ]);

    // –ü–æ–ª—É—á–∞–µ–º ad_groups –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
    const adGroupsResp = await fetch('/api/vk/ad-groups');
    const adGroupsData = await adGroupsResp.json();
    const adGroups = adGroupsData.data || [];

    // –°–æ–∑–¥–∞–µ–º –º–∞–ø–ø–∏–Ω–≥: campaign_id -> ad_group_ids
    const campaignToAdGroups: Record<number, number[]> = {};
    adGroups.forEach((ag: any) => {
      if (!campaignToAdGroups[ag.campaign_id]) {
        campaignToAdGroups[ag.campaign_id] = [];
      }
      campaignToAdGroups[ag.campaign_id].push(ag.id);
    });

    // –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å –∫–∞–º–ø–∞–Ω–∏—è–º–∏
    return campaigns.map((campaign: any) => {
      const campaignAdGroupIds = campaignToAdGroups[campaign.id] || [];
      
      // –§–∏–ª—å—Ç—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ ad_groups —ç—Ç–æ–π –∫–∞–º–ø–∞–Ω–∏–∏
      const campaignStats = stats.data?.filter((stat: any) =>
        campaignAdGroupIds.includes(stat.id)
      ) || [];

      // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      const aggregated = campaignStats.reduce((acc: any, stat: any) => {
        acc.shows += stat.base?.shows || 0;
        acc.clicks += stat.base?.clicks || 0;
        acc.spent += parseFloat(stat.base?.spent || '0');
        acc.goals += stat.base?.vk?.goals || 0;
        return acc;
      }, { shows: 0, clicks: 0, spent: 0, goals: 0 });

      const ctr = aggregated.shows > 0 ? (aggregated.clicks / aggregated.shows) * 100 : 0;
      const cpc = aggregated.clicks > 0 ? aggregated.spent / aggregated.clicks : 0;
      const cpm = aggregated.shows > 0 ? (aggregated.spent / aggregated.shows) * 1000 : 0;

      return {
        id: campaign.id,
        name: campaign.name,
        status: aggregated.shows > 0 ? "active" : "stopped",
        spent: aggregated.spent,
        budget_limit: campaign.budget_limit || 100000,
        budget_limit_day: campaign.budget_limit_day || 10000,
        statistics: {
          shows: aggregated.shows,
          clicks: aggregated.clicks,
          ctr: parseFloat(ctr.toFixed(2)),
          cpc: parseFloat(cpc.toFixed(2)),
          cpm: parseFloat(cpm.toFixed(2)),
          conversions: aggregated.goals,
          revenue: 0, // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≤—ã—Ä—É—á–∫–µ –≤ VK
          roas: 0,
        },
      };
    });
  } catch (error) {
    console.error("Error:", error);
    return mockCampaigns;
  }
}
```

---

## ‚úÖ –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò (–ü–û–≠–¢–ê–ü–ù–û)

### –≠—Ç–∞–ø 1: –°–æ–∑–¥–∞–Ω–∏–µ Cache Manager ‚úÖ

**–§–∞–π–ª:** `server/cache/cacheManager.ts`

```bash
mkdir server/cache
touch server/cache/cacheManager.ts
```

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:** –ü–æ–ª–Ω—ã–π –∫–æ–¥ CacheManager (—Å–º. –≤—ã—à–µ)

---

### –≠—Ç–∞–ø 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Yandex Routes ‚úÖ

**–û–±–Ω–æ–≤–∏—Ç—å:** `server/routes/yandex.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- `getOrders`: –¥–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- `getProducts`: –¥–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- `getCampaigns`: –¥–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ö–ª—é—á–∏ –∫—ç—à–∞:**
- Orders: `yandex:orders:all:${date_from}:${date_to}`
- Products: `yandex:products:all`
- Campaigns: `yandex:campaigns:all`

---

### –≠—Ç–∞–ø 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ VK Routes ‚úÖ

**–û–±–Ω–æ–≤–∏—Ç—å:** `server/routes/vk.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- `getCampaigns`: –¥–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- `getAdGroups`: –¥–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- `getBanners`: –¥–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- `getStatistics`: –¥–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (—Å —É—á–µ—Ç–æ–º ad_groups)

**–ö–ª—é—á–∏ –∫—ç—à–∞:**
- Campaigns: `vk:campaigns:${adPlanId || 'all'}`
- Ad Groups: `vk:adgroups:${campaignId || 'all'}`
- Banners: `vk:banners:${campaignId}:${adGroupId}`
- Statistics: `vk:stats:${date_from}:${date_to}`

---

### –≠—Ç–∞–ø 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ dataService ‚úÖ

**–û–±–Ω–æ–≤–∏—Ç—å:** `client/services/dataService.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- `getDashboardSummary`: –¥–æ–±–∞–≤–∏—Ç—å VK Statistics
- `getCampaigns`: –¥–æ–±–∞–≤–∏—Ç—å VK Statistics –∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ

---

### –≠—Ç–∞–ø 5: –ó–∞–º–µ–Ω–∞ Mock –î–∞–Ω–Ω—ã—Ö ‚ö†Ô∏è

**–û–±–Ω–æ–≤–∏—Ç—å:**
- `Dashboard.tsx`: –¢—Ä–µ–Ω–¥ –≤—ã—Ä—É—á–∫–∏ –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
- `Sales.tsx`: –ê–Ω–∞–ª–∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤

---

### –≠—Ç–∞–ø 6: Cache Management API ‚úÖ

**–°–æ–∑–¥–∞—Ç—å:** `server/routes/cache.ts`

```typescript
export const getCacheStats: RequestHandler = (req, res) => {
  const stats = cacheManager.getStats();
  res.json({
    success: true,
    stats,
  });
};

export const clearCache: RequestHandler = (req, res) => {
  const { pattern } = req.query;
  
  if (pattern) {
    const deleted = cacheManager.deletePattern(pattern as string);
    res.json({
      success: true,
      message: `Deleted ${deleted} entries matching "${pattern}"`,
    });
  } else {
    cacheManager.clear();
    res.json({
      success: true,
      message: 'Cache cleared completely',
    });
  }
};
```

**–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ `server/index.ts`:**
```typescript
import { getCacheStats, clearCache } from './routes/cache';

app.get('/api/cache/stats', getCacheStats);
app.delete('/api/cache/clear', clearCache);
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ö–≠–®–ê

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏:

```bash
# –ó–∞–ø—Ä–æ—Å 1 (Cache MISS)
curl http://localhost:8080/api/yandex/orders?date_from=2025-11-01&date_to=2025-11-15

# –ó–∞–ø—Ä–æ—Å 2 —Å —Ç–µ–º–∏ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (Cache HIT)
curl http://localhost:8080/api/yandex/orders?date_from=2025-11-01&date_to=2025-11-15

# –ó–∞–ø—Ä–æ—Å 3 —Å –¥—Ä—É–≥–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (Cache MISS)
curl http://localhost:8080/api/yandex/orders?date_from=2025-10-01&date_to=2025-10-31
```

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –ó–∞–ø—Ä–æ—Å 1: `cached: false`, –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ API
- –ó–∞–ø—Ä–æ—Å 2: `cached: true`, –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞ (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
- –ó–∞–ø—Ä–æ—Å 3: `cached: false`, –Ω–æ–≤—ã–π –∫–ª—é—á –∫—ç—à–∞

---

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ TTL:

```bash
# –ó–∞–ø—Ä–æ—Å
curl http://localhost:8080/api/yandex/orders?date_from=2025-11-01&date_to=2025-11-15

# –ü–æ–¥–æ–∂–¥–∞—Ç—å 6 –º–∏–Ω—É—Ç (TTL = 5 –º–∏–Ω—É—Ç)
sleep 360

# –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å (Cache MISS, —Ç.–∫. –∏—Å—Ç–µ–∫ TTL)
curl http://localhost:8080/api/yandex/orders?date_from=2025-11-01&date_to=2025-11-15
```

---

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ Cache Stats:

```bash
curl http://localhost:8080/api/cache/stats
```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "stats": {
    "totalEntries": 15,
    "oldestEntry": 1731689200000,
    "newestEntry": 1731689400000
  }
}
```

---

### 4. –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞:

```bash
# –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫—ç—à
curl -X DELETE http://localhost:8080/api/cache/clear

# –û—á–∏—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ VK –∫—ç—à
curl -X DELETE "http://localhost:8080/api/cache/clear?pattern=vk:"

# –û—á–∏—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ Yandex orders
curl -X DELETE "http://localhost:8080/api/cache/clear?pattern=yandex:orders"
```

---

## üìà –ú–û–ù–ò–¢–û–†–ò–ù–ì –ö–≠–®–ê

### –õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏:

```
‚úÖ Cache HIT: yandex:orders:all:2025-11-01:2025-11-15
‚ùå Cache MISS: vk:stats:2025-11-01:2025-11-15
üíæ Cached: yandex:products:all (1247 products)
üßπ Cache cleanup: —É–¥–∞–ª–µ–Ω–æ 5 —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π
```

### –î–æ–±–∞–≤–∏—Ç—å –≤ Dashboard (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):

```typescript
// –í Settings.tsx –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é Cache Stats
const [cacheStats, setCacheStats] = useState<any>(null);

useEffect(() => {
  fetch('/api/cache/stats')
    .then(r => r.json())
    .then(data => setCacheStats(data.stats));
}, []);

// UI:
<Card>
  <CardHeader>
    <CardTitle>Cache Statistics</CardTitle>
  </CardHeader>
  <CardContent>
    <p>Total Entries: {cacheStats?.totalEntries}</p>
    <p>Oldest: {new Date(cacheStats?.oldestEntry).toLocaleString()}</p>
    <Button onClick={() => fetch('/api/cache/clear', { method: 'DELETE' })}>
      Clear Cache
    </Button>
  </CardContent>
</Card>
```

---

## üéØ –ò–¢–û–ì–û–í–´–ô –ß–ï–ö–õ–ò–°–¢

### Backend:

- [ ] –°–æ–∑–¥–∞—Ç—å `server/cache/cacheManager.ts`
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `server/routes/yandex.ts`
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `server/routes/vk.ts`
- [ ] –°–æ–∑–¥–∞—Ç—å `server/routes/cache.ts`
- [ ] –†–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å cache routes –≤ `server/index.ts`

### Frontend:

- [ ] –û–±–Ω–æ–≤–∏—Ç—å `dataService.getDashboardSummary()` (–¥–æ–±–∞–≤–∏—Ç—å VK Stats)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `dataService.getCampaigns()` (–¥–æ–±–∞–≤–∏—Ç—å VK Stats)
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å mock —Ç—Ä–µ–Ω–¥ –≤—ã—Ä—É—á–∫–∏ –≤ `Dashboard.tsx`
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å mock –∞–Ω–∞–ª–∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ `Sales.tsx`

### Testing:

- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é –∫—ç—à–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å TTL expiration
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Cache Stats API
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Clear Cache API
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Dashboard —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ VK Stats

---

## üöÄ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

### –î–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| Dashboard ROAS | 0 –∏–ª–∏ NaN |
| Dashboard CTR | 0% |
| Dashboard CPC | 0‚ÇΩ |
| Marketing –ø–æ–∫–∞–∑—ã | 0 |
| Marketing –∫–ª–∏–∫–∏ | 0 |
| –ó–∞–ø—Ä–æ—Å–æ–≤ –∫ API –∑–∞ –∑–∞–≥—Ä—É–∑–∫—É Dashboard | 3 (orders, campaigns, products) |
| –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ Dashboard | ~2-3 —Å–µ–∫—É–Ω–¥—ã |

### –ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| Dashboard ROAS | 5.23 (—Ä–µ–∞–ª—å–Ω—ã–π) |
| Dashboard CTR | 0.64% (—Ä–µ–∞–ª—å–Ω—ã–π) |
| Dashboard CPC | 21.88‚ÇΩ (—Ä–µ–∞–ª—å–Ω—ã–π) |
| Marketing –ø–æ–∫–∞–∑—ã | 104,488 (—Ä–µ–∞–ª—å–Ω—ã–µ) |
| Marketing –∫–ª–∏–∫–∏ | 669 (—Ä–µ–∞–ª—å–Ω—ã–µ) |
| –ó–∞–ø—Ä–æ—Å–æ–≤ –∫ API –∑–∞ –∑–∞–≥—Ä—É–∑–∫—É Dashboard (1–π —Ä–∞–∑) | 4 (orders, campaigns, products, vk stats) |
| –ó–∞–ø—Ä–æ—Å–æ–≤ –∫ API –∑–∞ –∑–∞–≥—Ä—É–∑–∫—É Dashboard (2–π —Ä–∞–∑) | 0 (–≤—Å–µ –∏–∑ –∫—ç—à–∞) |
| –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ Dashboard (—Å –∫—ç—à–µ–º) | ~50-100ms |

---

**–í–ê–ñ–ù–û:** –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è:
1. –°–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ API
2. –ò–∑–±–µ–∂–∞–Ω–∏—è rate limits
3. –£—Å–∫–æ—Ä–µ–Ω–∏—è –æ—Ç–∫–ª–∏–∫–∞ UI
4. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≥–æ–¥ (–∑–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å—Å—è)

