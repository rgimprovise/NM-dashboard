# Известные проблемы и задачи на доработку

## 1C File Upload - Специфические структуры отчетов

**Дата обнаружения:** 2025-12-10  
**Статус:** ⚠️ ТРЕБУЕТ ДОРАБОТКИ  
**Приоритет:** Средний

**Описание:**
Файлы `sales_margin.xlsx`, `stock_turnover.xlsx` и `stock_turnover_agg.xlsx` имеют специфическую структуру - это не простые таблицы, а отчеты с параметрами, заголовками и сложной структурой данных.

**Детали:**
- Эти файлы содержат:
  - Параметры отчета (период, способ расчета и т.д.)
  - Заголовки и подзаголовки
  - Сложную структуру с группировками
  - Итоговые строки
- Текущий парсер ожидает простую таблицу с заголовками в первой строке
- Автоматический маппинг не работает для таких файлов

**Текущее состояние:**
- ✅ Импорт работает для:
  - `products.xlsx` (номенклатура)
  - `returns.xlsx` (возвраты)
  - `categories.xlsx` (категории)
- ❌ Импорт НЕ работает для:
  - `sales_margin.xlsx` (продажи и маржа - отчет)
  - `stock_turnover.xlsx` (оборачиваемость склада - отчет)
  - `stock_turnover_agg.xlsx` (агрегированная оборачиваемость - отчет)

**Требуется доработка:**
1. Анализ структуры отчетов:
   - Определить, где находятся данные (какой лист, какая строка начала данных)
   - Определить, где находятся параметры отчета
   - Определить структуру группировок
2. Создать специальные парсеры для отчетов:
   - Парсер для `sales_margin.xlsx` (отчет "Валовая прибыль предприятия")
   - Парсер для `stock_turnover.xlsx` (отчет "Оборачиваемость запасов на складах")
   - Парсер для `stock_turnover_agg.xlsx` (агрегированный отчет)
3. Обработка параметров:
   - Извлечение периода из параметров отчета
   - Извлечение способа расчета
   - Сохранение метаданных отчета
4. Обработка структуры данных:
   - Пропуск заголовков и параметров
   - Обработка группировок (подразделения, менеджеры, склады)
   - Пропуск итоговых строк
   - Правильное извлечение данных из вложенных структур

**Связанные файлы:**
- `server/services/oneCDataLoader.ts` - функции `loadOneCSalesMargin()`, `loadOneCStockTurnover()`
- `server/routes/oneC.ts` - endpoint `/api/1c/upload-products`
- `client/pages/Upload1C.tsx` - UI загрузки файлов

**Примеры структуры:**
- `sales_margin.xlsx`: Отчет "Валовая прибыль предприятия" с секциями "По подразделениям" и "По менеджерам"
- `stock_turnover.xlsx`: Отчет "Оборачиваемость запасов на складах" с параметрами и группировками по складам
- `stock_turnover_agg.xlsx`: Агрегированный отчет оборачиваемости

---

## Yandex Market API - Расширение данных по рекламе

**Дата обнаружения:** 2025-12-10  
**Статус:** ⚠️ ТРЕБУЕТ ДОРАБОТКИ  
**Приоритет:** Средний

**Описание:**
В Yandex Market API также есть данные по рекламе, которые необходимо учитывать в аналитике. В настоящее время мы получаем только данные по заказам, но не получаем данные по рекламным кампаниям и расходам.

**Требуется доработка:**
1. Изучить Yandex Market Partner API на предмет получения данных по рекламе:
   - Рекламные кампании
   - Расходы на рекламу
   - Статистика по кампаниям (показы, клики, конверсии)
   - Связь заказов с рекламными кампаниями
2. Расширить `server/routes/yandex.ts` для получения данных по рекламе
3. Обновить `client/services/api/yandexClient.ts` для работы с рекламными данными
4. Интегрировать данные по рекламе Yandex в:
   - Dashboard KPI (расходы на рекламу, ROAS)
   - Marketing страницу (кампании Yandex)
   - Сквозную воронку (агрегация с VK Ads)
5. Обновить расчеты KPI с учетом рекламы Yandex:
   - Общие расходы на рекламу = VK Ads + Yandex Ads
   - Общий ROAS = (Выручка) / (VK Ads + Yandex Ads)
   - Разделение метрик по источникам рекламы

**Связанные файлы:**
- `server/routes/yandex.ts` - endpoints для Yandex Market API
- `client/services/api/yandexClient.ts` - клиент для работы с Yandex API
- `server/routes/dashboardRoutes.ts` - расчет Dashboard KPI
- `client/pages/Marketing.tsx` - страница маркетинга
- `client/services/dataService.ts` - агрегация данных

**См. также:** Документация Yandex Market Partner API

---

## VK Ads API - Отображение кампаний и групп

### Проблема: Активные кампании VK Ads

**Дата обнаружения:** 2025-12-10  
**Статус:** ⚠️ ТРЕБУЕТ ДОРАБОТКИ  
**Приоритет:** Средний

**Описание:**
На странице Marketing в блоке "Активные кампании VK Ads" отображаются **группы объявлений (ad_groups)**, а не кампании (campaigns).

**Детали:**
- В интерфейсе VK показывается 17 кампаний (3 активных)
- API возвращает 55 кампаний
- В нашем дашборде отображаются группы объявлений с их статистикой
- Статистика корректная, но это данные по группам, а не по кампаниям

**Текущее состояние:**
- ✅ Блок отображается и показывает данные
- ✅ Фильтрация работает (показываются только группы с реальной статистикой)
- ✅ Данные корректные
- ❌ Терминология неверная (называем "кампании", но показываем "группы")

**Варианты решения:**
1. **Переименовать блок** в "Активные группы объявлений VK Ads"
2. **Разделить отображение:**
   - Кампании (с агрегированной статистикой по всем группам)
   - Группы (детальная статистика)
3. **Реализовать иерархию:**
   - Кампании → Группы → Объявления
   - С возможностью раскрытия/сворачивания

**Технические детали:**
- Endpoint: `/api/vk/statistics` использует `/statistics/campaigns/`
- Статистика корректно агрегируется по campaign_id
- Проблема в том, что VK API возвращает статистику по campaigns, но в интерфейсе VK показываются группы

**Связанные файлы:**
- `client/pages/Marketing.tsx` - блок "Активные кампании VK Ads"
- `server/routes/vk.ts` - endpoint `/api/vk/statistics`
- `client/services/dataService.ts` - метод `getCampaigns()`

