# Структура данных VK Ads API

## Обзор

VK Ads API v2 предоставляет данные о рекламных кампаниях через endpoint `/api/vk/statistics`.

## Формат ответа

### Endpoint: `GET /api/vk/statistics?date_from=YYYY-MM-DD&date_to=YYYY-MM-DD`

**Структура ответа:**
```json
{
  "success": true,
  "data": [
    {
      "date": "2025-12-02",
      "shows": 17270,
      "clicks": 97,
      "spent": 1910.28,
      "ctr": 0.56,
      "cpc": 19.69,
      "cpm": 110.61
    },
    // ... другие дни
  ],
  "total": {
    "shows": 118798,
    "clicks": 639,
    "spent": 14974.78,
    "ctr": 0.54,
    "cpc": 23.41,
    "cpm": 126.05,
    "goals": 83
  },
  "cached": false
}
```

## Поля данных

### Массив `data[]` (по дням)

Каждый элемент массива содержит агрегированные данные за один день:

| Поле | Тип | Описание |
|------|-----|----------|
| `date` | string | Дата в формате YYYY-MM-DD |
| `shows` | number | Количество показов за день |
| `clicks` | number | Количество кликов за день |
| `spent` | number | Расходы за день (в рублях) |
| `ctr` | number | Click-Through Rate (клики/показы * 100) |
| `cpc` | number | Cost Per Click (расходы/клики) |
| `cpm` | number | Cost Per Mille (расходы/показы * 1000) |

### Объект `total` (агрегированные данные за период)

| Поле | Тип | Описание |
|------|-----|----------|
| `shows` | number | Общее количество показов за период |
| `clicks` | number | Общее количество кликов за период |
| `spent` | number | Общие расходы за период (в рублях) |
| `ctr` | number | Средний CTR за период |
| `cpc` | number | Средний CPC за период |
| `cpm` | number | Средний CPM за период |
| `goals` | number | Количество достигнутых целей (конверсий) |

## Источник данных

Данные получаются из VK Ads API v2 через endpoint:
- `/statistics/ad_groups/day.json` (при указании дат)
- `/statistics/ad_groups/summary.json` (без дат)

**Параметры запроса:**
- `id` - список ID ad_groups через запятую
- `account_id` - ID рекламного кабинета (из .env: `VK_ACCOUNT_ID`)
- `metrics` - метрики для получения (обычно "base")
- `date_from` - начальная дата (YYYY-MM-DD)
- `date_to` - конечная дата (YYYY-MM-DD)

## Обработка данных на бэкенде

1. **Получение ad_groups**: Сначала получаем список всех ad_groups для аккаунта
2. **Запрос статистики**: Запрашиваем статистику по всем ad_groups за указанный период
3. **Преобразование**: VK API возвращает структуру `items[].rows[]`, которая преобразуется в плоский массив по дням
4. **Агрегация**: Данные агрегируются по датам (суммируются показы, клики, расходы для каждого дня)
5. **Расчет метрик**: Для каждого дня рассчитываются CTR, CPC, CPM

## Использование в приложении

### На странице Marketing

Данные используются для:
- **Карточки KPI**: CTR, CPC, CPM, ROAS, Conversion Rate, AOV
- **Таблица динамики**: Ежедневная статистика по дням

### В Analytics API

Данные нормализуются в `FactVkAd` через `toFactVkAds()`:
- Преобразуются в star-schema формат
- Используются для расчета сквозной воронки
- Агрегируются с данными Yandex и 1C

## Особенности

1. **Агрегированные данные**: Данные уже агрегированы по дням на бэкенде
2. **Отсутствие campaign_id**: Агрегированные данные по дням не содержат `campaign_id`, используется "aggregated"
3. **Кэширование**: Данные кэшируются на 10 минут (600 секунд)
4. **Обработка ошибок**: При ошибках возвращается пустой массив или нулевые значения

## Примеры использования

### Получение статистики за 7 дней
```bash
curl "http://localhost:8080/api/vk/statistics?date_from=2025-12-02&date_to=2025-12-09"
```

### Использование в коде
```typescript
const stats = await vkAPI.getStatistics("2025-12-02", "2025-12-09");
// stats - массив объектов с полями: date, shows, clicks, spent, ctr, cpc, cpm
```

## Логирование

Все запросы к VK API логируются в `logs/info.log`:
- Запросы статистики
- Полученные данные
- Ошибки обработки
- Агрегированные метрики

